<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retro T9 Communicator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PeerJS (Open Source P2P Networking) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Roboto:wght@500;700;900&family=VT323&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'retro': ['"VT323"', 'monospace'],
                        'tech': ['"Orbitron"', 'sans-serif'],
                        'modern': ['"Roboto"', 'sans-serif'],
                    },
                    boxShadow: {
                        'inner-lg': 'inset 0 2px 10px 0 rgba(0, 0, 0, 0.3)',
                        'btn': '0 4px 0 rgba(0,0,0,0.2)',
                        'btn-press': '0 0 0 rgba(0,0,0,0)',
                    }
                }
            }
        }
    </script>

    <style>
        /* --- CORE ANIMATIONS --- */
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .cursor-blink { animation: blink 1s infinite; }
        
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        .scanline::after {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.05) 51%);
            background-size: 100% 4px;
            pointer-events: none;
        }

        /* --- SCROLLBAR --- */
        .scrollbar-hide::-webkit-scrollbar { width: 4px; }
        .scrollbar-hide::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-hide::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px; }
        
        /* --- THEME ENGINE --- */
        :root {
            --screen-height: 240px;
        }

        .phone-body, .screen, .key, .key-content {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .screen {
            height: var(--screen-height);
        }

        /* 1. PLASTIC BLUE (Backlight: Amber) */
        [data-theme="plastic-blue"] .phone-body {
            background: linear-gradient(160deg, #4c5fc0, #3e50b4);
            border: 4px solid #2a3b8f; border-radius: 2.5rem;
            box-shadow: inset -5px -5px 15px rgba(0,0,0,0.2), 10px 10px 30px rgba(0,0,0,0.3);
            height: 680px;
        }
        [data-theme="plastic-blue"] .screen {
            background-color: #9ea758; color: #111; font-family: 'VT323', monospace;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2);
            font-weight: bold; /* Increased readability */
        }
        .dark [data-theme="plastic-blue"] .screen {
            background-color: #b0bb64; 
            box-shadow: 0 0 30px rgba(176, 187, 100, 0.6); 
            border: 1px solid rgba(0,0,0,0.2);
        }
        .dark [data-theme="plastic-blue"] .key-content {
            color: #ffcc00; text-shadow: 0 0 10px #ffaa00; 
        }
        .dark [data-theme="plastic-blue"] .key {
            background: rgba(20, 20, 40, 0.8);
            border: 1px solid rgba(255, 200, 0, 0.1);
        }


        /* 2. PLASTIC SILVER (Backlight: EL Blue) */
        [data-theme="plastic-silver"] .phone-body {
            background: linear-gradient(135deg, #e2e2e2, #bfbfbf);
            border: 3px solid #999; border-radius: 1.5rem;
            box-shadow: inset 0 0 15px rgba(255,255,255,0.5), 10px 10px 30px rgba(0,0,0,0.2);
            height: 680px;
        }
        [data-theme="plastic-silver"] .screen {
            background-color: #c4dffa; color: #000; font-family: 'Roboto', sans-serif;
            font-weight: 700;
        }
        .dark [data-theme="plastic-silver"] .screen {
            background-color: #dbeeff; 
            box-shadow: 0 0 35px rgba(77, 166, 255, 0.7);
        }
        .dark [data-theme="plastic-silver"] .key-content {
            color: #00ffff; text-shadow: 0 0 8px #0088ff; 
        }
        .dark [data-theme="plastic-silver"] .key {
            background: rgba(0, 0, 0, 0.6);
        }


        /* 3. METAL SILVER (Backlight: Cyber Green) */
        [data-theme="metal-silver"] .phone-body {
            background: linear-gradient(135deg, #f0f0f0 0%, #d7d7d7 50%, #aaaaaa 100%);
            border: 2px solid #666; border-radius: 0.5rem;
            height: 680px;
        }
        [data-theme="metal-silver"] .screen {
            background-color: #111; color: #00ff00; font-family: 'Orbitron', sans-serif; border: 1px solid #333;
        }
        .dark [data-theme="metal-silver"] .screen {
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5); 
            text-shadow: 0 0 5px #00ff00; border-color: #00ff00;
        }
        .dark [data-theme="metal-silver"] .key-content {
            color: #00ff00; text-shadow: 0 0 8px #00ff00; 
        }
        .dark [data-theme="metal-silver"] .key {
            background: #1a1a1a;
            border-bottom: 2px solid #00ff00;
        }


        /* 4. METAL BLACK (Backlight: White LED) */
        [data-theme="metal-black"] .phone-body {
            background: linear-gradient(135deg, #333 0%, #111 100%);
            border: 2px solid #000; border-radius: 1.2rem;
            height: 680px;
        }
        [data-theme="metal-black"] .screen {
            background-color: #000; color: #fff; font-family: 'Roboto', sans-serif;
        }
        .dark [data-theme="metal-black"] .screen {
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.4); 
        }
        .dark [data-theme="metal-black"] .key-content {
            color: #ffffff; text-shadow: 0 0 10px #ffffff;
        }
        .dark [data-theme="metal-black"] .key {
            background: #000;
            border: 1px solid #333;
        }

        /* 5. MULTIMEDIA (Nokia 6630/230 Vibe) */
        [data-theme="multimedia"] .phone-body {
            background: linear-gradient(180deg, #f8f9fa 0%, #dcdcdc 100%);
            border: 3px solid #bbb;
            border-radius: 20px 20px 45px 45px;
            width: 340px; 
            height: 760px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.2), inset 0 2px 10px rgba(255,255,255,0.8);
        }
        [data-theme="multimedia"] .screen {
            --screen-height: 320px;
            background-color: #f0f0f0; color: #111; font-family: 'Roboto', sans-serif;
            border: 1px solid #ccc;
            font-weight: 700;
        }
        .dark [data-theme="multimedia"] .screen {
            background-color: #1a1a1a; color: #fff;
            box-shadow: 0 0 40px rgba(255,255,255,0.1);
            border: 1px solid #333;
        }
        [data-theme="multimedia"] .key {
            border-radius: 20px; 
            background: linear-gradient(to bottom, #fff, #eee);
            box-shadow: 0 2px 0 #ccc;
            margin: 2px;
        }
        .dark [data-theme="multimedia"] .key {
            background: #333;
            box-shadow: 0 2px 0 #111;
            border: 1px solid #444;
        }
        .dark [data-theme="multimedia"] .key-content {
            color: #fff; text-shadow: 0 0 5px #fff;
        }

        /* 6. CALCULATOR (ClassWiz Style) */
        [data-theme="calculator"] .phone-body {
            /* Carbon fiber-ish texture */
            background-color: #1a1a1a;
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 4px);
            border: none;
            border-radius: 10px;
            width: 340px;
            height: 700px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5), inset 0 0 20px rgba(0,0,0,0.8);
        }
        [data-theme="calculator"] .screen {
            background-color: #e8f4f8; 
            color: #000; 
            font-family: 'Roboto', sans-serif;
            font-weight: 900;
            border-left: 8px solid #000;
            border-top: 4px solid #000;
            border-radius: 2px;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1);
        }
        .dark [data-theme="calculator"] .screen {
            background-color: #f0f8ff; /* Stays bright like a calculator LCD */
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }
        /* Calc Keys */
        [data-theme="calculator"] .key {
            border-radius: 4px;
            box-shadow: 0 2px 0 #000;
            background: #fff; /* White number keys */
            margin: 3px;
            border: 1px solid #ccc;
        }
        [data-theme="calculator"] .key-content span:first-child {
            font-family: 'Roboto', sans-serif;
            font-weight: 900;
        }
        [data-theme="calculator"] .key-content span:last-child {
            color: #0055aa; /* Blue function text */
            font-weight: 700;
        }
        /* Special colors for calc theme */
        [data-theme="calculator"] .nav-key {
            background: #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 0 #999;
        }
        
        /* Nav Key Styling Default */
        .nav-key {
            background: rgba(255,255,255,0.9);
            border-radius: 6px;
            box-shadow: 0 3px 0 rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        .dark .nav-key {
            background: rgba(0,0,0,0.5);
            color: inherit; 
            box-shadow: 0 3px 0 rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* Common Dark Mode Nav Glows */
        .dark [data-theme="plastic-blue"] .nav-key { color: #ffcc00; text-shadow: 0 0 5px #ffaa00; }
        .dark [data-theme="plastic-silver"] .nav-key { color: #00ffff; text-shadow: 0 0 5px #00ffff; }
        .dark [data-theme="metal-silver"] .nav-key { color: #00ff00; text-shadow: 0 0 5px #00ff00; }
        .dark [data-theme="metal-black"] .nav-key { color: #fff; text-shadow: 0 0 5px #fff; }
        .dark [data-theme="calculator"] .nav-key { color: #fff; text-shadow: 0 0 5px #fff; background: #333; }

        .nav-key:active { transform: translateY(2px); box-shadow: none; }
        
        .menu-item.selected {
            background-color: rgba(0,0,0,0.1);
            font-weight: 900;
        }
        .dark .menu-item.selected {
            background-color: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body class="bg-slate-200 dark:bg-slate-900 flex flex-col items-center justify-center min-h-screen transition-colors duration-700 overflow-hidden select-none">

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-10 opacity-0 transition-opacity duration-300 bg-black/90 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-xl z-50 pointer-events-none border border-white/20">
        System Ready
    </div>

    <!-- The Phone Device -->
    <div id="phone-wrapper" data-theme="plastic-blue" class="relative transition-all duration-300 scale-[0.85] sm:scale-100">
        
        <!-- Phone Chassis -->
        <div class="phone-body w-[320px] p-5 relative flex flex-col gap-4">
            
            <!-- Ear Speaker -->
            <div class="shrink-0 flex flex-col items-center gap-1 mt-1">
                <div class="w-14 h-1.5 bg-black/20 dark:bg-black/40 rounded-full shadow-inner"></div>
                <div class="text-[0.6rem] font-bold tracking-[0.3em] opacity-40 uppercase">Omni-Link</div>
            </div>

            <!-- LCD Screen -->
            <div class="bg-black/5 dark:bg-black/20 p-2 rounded-xl shrink-0 transition-colors">
                <div id="lcd-screen" class="screen w-full rounded p-3 flex flex-col relative overflow-hidden scanline transition-all duration-300">
                    
                    <!-- Status Bar -->
                    <div class="flex justify-between items-center text-[10px] opacity-80 border-b border-current/20 pb-1 mb-1 shrink-0 font-bold z-10">
                        <div class="flex items-center gap-1">
                            <span id="net-icon">üì∂</span>
                            <span id="net-status">INIT</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="battery-icon">üîã</span>
                        </div>
                    </div>

                    <!-- SCREEN: BOOT -->
                    <div id="screen-boot" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-inherit">
                        <span class="text-2xl animate-pulse font-bold tracking-widest">OMNI</span>
                        <span class="text-xs tracking-[0.5em] mt-2">SYSTEMS</span>
                        <div class="w-16 h-1 bg-current/20 mt-4 rounded overflow-hidden">
                            <div class="h-full bg-current w-1/2 animate-pulse"></div>
                        </div>
                    </div>

                    <!-- SCREEN: CHAT -->
                    <div id="screen-chat" class="flex-1 flex flex-col overflow-hidden relative">
                         <div id="chat-log" class="flex-1 overflow-y-auto scrollbar-hide flex flex-col gap-2 pb-1 text-sm font-bold leading-snug">
                             <div class="text-center opacity-60 mt-8 text-xs font-normal">
                                 <p>DISCONNECTED</p>
                                 <p class="text-[10px] mt-1">Select RADIO to Connect</p>
                             </div>
                         </div>
                         <div class="shrink-0 border-t-2 border-current/20 pt-1 min-h-[1.5em] flex flex-wrap text-lg font-bold leading-none break-all relative bg-inherit z-10">
                             <span id="confirmed-text"></span><span id="pending-text" class="bg-current/20"></span><span class="cursor-blink w-[3px] h-[1em] bg-current ml-[1px] inline-block align-middle"></span>
                        </div>
                    </div>

                    <!-- SCREEN: MENU -->
                    <div id="screen-menu" class="absolute inset-0 z-20 bg-inherit flex flex-col hidden p-2 pt-4">
                        <div class="text-center font-black border-b-2 border-current/30 pb-1 mb-2 tracking-widest text-lg">MENU</div>
                        <div id="menu-list" class="flex-1 flex flex-col gap-1 overflow-y-auto text-sm font-bold">
                            <!-- JS Injects Items Here -->
                        </div>
                    </div>

                    <!-- SCREEN: DIALER (COMBINED ID & INPUT) -->
                    <div id="screen-dialer" class="absolute inset-0 z-20 bg-inherit flex flex-col hidden p-4 pt-6 items-center">
                        <!-- My ID Section -->
                        <div class="w-full bg-current/5 p-2 rounded mb-4 text-center border border-current/20">
                            <div class="text-[9px] opacity-60 font-bold uppercase tracking-widest mb-1">MY FREQUENCY</div>
                            <div id="my-id-display" class="text-xl font-mono font-black tracking-widest select-all">-----</div>
                        </div>

                        <!-- Target Input Section -->
                        <div class="w-full text-center">
                            <div class="text-[9px] opacity-60 font-bold uppercase tracking-widest mb-1">TARGET FREQUENCY</div>
                            <div id="dial-input" class="text-3xl font-mono font-black border-b-4 border-current w-full text-center py-2 mb-2 tracking-widest"></div>
                        </div>
                    </div>

                    <!-- SCREEN: CONNECTING -->
                    <div id="screen-connecting" class="absolute inset-0 z-30 bg-inherit flex flex-col hidden items-center justify-center">
                        <div class="loading-spinner w-8 h-8 border-4 rounded-full animate-spin mb-4"></div>
                        <div class="text-sm font-bold animate-pulse">CONNECTING...</div>
                    </div>
                    
                    <!-- SCREEN: CONNECTED CONFIRM -->
                    <div id="screen-confirmed" class="absolute inset-0 z-30 bg-inherit flex flex-col hidden items-center justify-center">
                        <div class="text-4xl mb-2">ü§ù</div>
                        <div class="text-lg font-black tracking-widest">LINKED!</div>
                    </div>

                    <!-- Soft Keys Bar -->
                    <div class="absolute bottom-0 left-0 right-0 h-6 bg-current/10 flex justify-between items-center px-2 text-[10px] font-bold uppercase z-40 backdrop-blur-[1px]">
                        <span id="soft-left-label">Menu</span>
                        <span id="mode-label" class="opacity-50 font-normal lowercase">abc</span>
                        <span id="soft-right-label">Clear</span>
                    </div>

                </div>
            </div>

            <!-- Navigation Controls -->
            <div class="grid grid-cols-3 gap-3 px-1 h-12 shrink-0 py-2 mb-1">
                <button onclick="handleSoftLeft()" class="nav-key flex items-center justify-center font-bold text-xs uppercase tracking-wider">
                    <div class="w-4 h-1 bg-current opacity-50 rounded-full"></div>
                </button>
                <div class="flex flex-col gap-1">
                    <button onclick="handleNav('UP')" class="nav-key flex-1 flex items-center justify-center text-[10px]">‚ñ≤</button>
                    <button onclick="handleNav('DOWN')" class="nav-key flex-1 flex items-center justify-center text-[10px]">‚ñº</button>
                </div>
                <button onclick="handleSoftRight()" class="nav-key flex items-center justify-center font-bold text-xs uppercase tracking-wider">
                    <div class="w-4 h-1 bg-current opacity-50 rounded-full"></div>
                </button>
            </div>

            <!-- Numeric Keypad -->
            <div class="grid grid-cols-3 gap-3 mt-auto mb-2 px-1">
                <!-- Keys generated by JS -->
            </div>
        </div>
    </div>

    <script>
        // --- SOUND ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const SoundEngine = {
            playTone: (freq, type, duration) => {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            },
            click: () => SoundEngine.playTone(800, 'sine', 0.05),
            confirm: () => {
                SoundEngine.playTone(1200, 'sine', 0.1);
                setTimeout(() => SoundEngine.playTone(1800, 'sine', 0.2), 100);
            },
            cancel: () => {
                SoundEngine.playTone(300, 'square', 0.1);
                setTimeout(() => SoundEngine.playTone(200, 'square', 0.2), 100);
            },
            msgReceived: () => {
                SoundEngine.playTone(800, 'square', 0.08);
                setTimeout(() => SoundEngine.playTone(1200, 'square', 0.08), 150);
            },
            msgSent: () => {
                SoundEngine.playTone(600, 'sine', 0.1);
                setTimeout(() => SoundEngine.playTone(1200, 'sine', 0.2), 80);
            }
        };

        // --- STATE MANAGEMENT ---
        const State = {
            mode: 'BOOT',
            text: "",
            pendingChar: "",
            lastKey: null,
            capsMode: false,
            menuIndex: 0,
            dialBuffer: "",
            peer: null,
            conn: null,
            myId: "...",
            themeIndex: 0
        };

        const THEMES = ['plastic-blue', 'plastic-silver', 'metal-silver', 'metal-black', 'multimedia', 'calculator'];
        const MENU_ITEMS = [
            { label: 'Radio / Connect', action: 'GOTO_DIALER' }, // Combined
            { label: 'Toggle Theme', action: 'TOGGLE_THEME' },
            { label: 'Dark Mode', action: 'TOGGLE_DARK' },
            { label: 'Reset Signal', action: 'RESET_NET' }
        ];

        const keyData = [
            { k: '1', s: '.,?!' }, { k: '2', s: 'abc' }, { k: '3', s: 'def' },
            { k: '4', s: 'ghi' }, { k: '5', s: 'jkl' }, { k: '6', s: 'mno' },
            { k: '7', s: 'pqrs' }, { k: '8', s: 'tuv' }, { k: '9', s: 'wxyz' },
            { k: '*', s: 'SHIFT' }, { k: '0', s: 'SPACE' }, { k: '#', s: 'SEND' }
        ];

        // --- INIT ---
        window.onload = () => {
            const grid = document.querySelector('.grid.mt-auto');
            grid.innerHTML = keyData.map(d => `
                <button class="key h-12 rounded-lg bg-white/90 shadow-btn active:shadow-btn-press active:translate-y-[2px] transition-all flex flex-col items-center justify-center group select-none" onclick="handleKey('${d.k}')" data-key="${d.k}">
                    <div class="key-content flex flex-col items-center transition-all duration-500">
                        <span class="text-xl font-bold leading-none">${d.k}</span>
                        <span class="text-[0.5rem] font-bold opacity-60 tracking-widest mt-0.5">${d.s}</span>
                    </div>
                </button>
            `).join('');

            setTimeout(() => {
                document.getElementById('screen-boot').classList.add('hidden');
                State.mode = 'CHAT';
                renderUI();
                initPeer();
            }, 2000);
        };

        // --- NETWORK (PEERJS) ---
        function initPeer() {
            if(State.peer) State.peer.destroy();
            
            const numericId = Math.floor(10000 + Math.random() * 90000);
            State.peer = new Peer(numericId.toString());

            State.peer.on('open', (id) => {
                State.myId = id;
                document.getElementById('my-id-display').innerText = id; // For Dialer Screen
                document.getElementById('net-status').innerText = "RDY";
                showToast(`Frequency: ${id}`);
            });

            State.peer.on('connection', (conn) => {
                // Ensure only one connection active
                if(State.conn) State.conn.close();
                
                setupConnection(conn);
                SoundEngine.msgReceived();
                showToast(`Incoming: ${conn.peer}`);
            });

            State.peer.on('error', (err) => {
                console.error(err);
                document.getElementById('net-status').innerText = "ERR";
                showToast("Network Error - Retrying");
                setTimeout(initPeer, 3000); // Auto Retry
            });
        }

        function connectTo(targetId) {
            if(!targetId) return;
            if(targetId === State.myId.toString()) {
                showToast("Cannot dial self");
                return;
            }

            State.mode = 'CONNECTING';
            renderUI();
            SoundEngine.confirm();

            // Close existing
            if(State.conn) State.conn.close();

            const conn = State.peer.connect(targetId);
            
            // Connection Timeout 
            const failTimer = setTimeout(() => {
                if(State.mode === 'CONNECTING') {
                    showToast("Connection Timeout");
                    State.mode = 'DIALER';
                    renderUI();
                    SoundEngine.cancel();
                }
            }, 8000);

            // Fake delay for UI satisfaction
            const delay = new Promise(r => setTimeout(r, 1500));

            conn.on('open', async () => {
                await delay;
                clearTimeout(failTimer);
                
                // Show Confirmation
                document.getElementById('screen-connecting').classList.add('hidden');
                document.getElementById('screen-confirmed').classList.remove('hidden');
                SoundEngine.msgReceived(); // Triumph sound
                
                setTimeout(() => {
                    document.getElementById('screen-confirmed').classList.add('hidden');
                    setupConnection(conn);
                    State.mode = 'CHAT';
                    renderUI();
                }, 1500);
            });
            
            conn.on('error', () => {
                clearTimeout(failTimer);
                State.mode = 'DIALER';
                renderUI();
                showToast("Conn Failed");
            });
        }

        function setupConnection(conn) {
            State.conn = conn;
            document.getElementById('net-status').innerText = "LINK";
            
            // Clear offline msg
            const log = document.getElementById('chat-log');
            if(log.innerText.includes("DISCONNECTED")) log.innerHTML = "";
            
            addSystemMsg(`LINKED TO: ${conn.peer}`);

            conn.on('data', (data) => {
                addMessage("PARTNER", data, false);
                SoundEngine.msgReceived();
            });

            conn.on('close', () => {
                State.conn = null;
                document.getElementById('net-status').innerText = "RDY";
                addSystemMsg("SIGNAL LOST");
                SoundEngine.cancel();
            });
        }

        // --- CORE LOGIC ---

        function handleKey(k) {
            visualFeedback(k);
            SoundEngine.click();

            if (State.mode === 'CHAT') {
                handleT9Input(k);
            } else if (State.mode === 'DIALER') {
                if (k >= '0' && k <= '9') {
                    if (State.dialBuffer.length < 5) {
                        State.dialBuffer += k;
                        renderUI();
                    }
                } 
                // Don't handle special keys here, wait for Soft Keys
            }
        }

        const t9Map = {
            '1':['.',',','!','?','1'], '2':['a','b','c','2'], '3':['d','e','f','3'],
            '4':['g','h','i','4'], '5':['j','k','l','5'], '6':['m','n','o','6'],
            '7':['p','q','r','s','7'], '8':['t','u','v','8'], '9':['w','x','y','z','9'],
            '0':[' ','0']
        };
        let t9Timer = null;

        function handleT9Input(k) {
            if(k === '#') { // Send
                commitChar();
                const msg = State.text.trim();
                if(!msg) return;
                
                if(State.conn) {
                    State.conn.send(msg);
                    addMessage("ME", msg, true);
                    SoundEngine.msgSent();
                } else {
                    addMessage("ME", msg, true);
                    setTimeout(() => addSystemMsg("Signal Failed"), 500);
                    SoundEngine.cancel();
                }
                State.text = "";
                renderUI();
                return;
            }

            if(k === '*') { // Shift
                State.capsMode = !State.capsMode;
                if(State.pendingChar) {
                    State.pendingChar = applyCaps(State.pendingChar);
                }
                renderUI();
                return;
            }
            
            if(k === '0') {
                 commitChar();
                 State.text += " ";
                 renderUI();
                 return;
            }

            const chars = t9Map[k];
            if(!chars) return;

            if(State.lastKey === k && State.pendingChar) {
                clearTimeout(t9Timer);
                State.cycleIndex = (State.cycleIndex + 1) % chars.length;
            } else {
                commitChar();
                State.lastKey = k;
                State.cycleIndex = 0;
            }

            State.pendingChar = applyCaps(chars[State.cycleIndex]);
            t9Timer = setTimeout(() => commitChar(), 800);
            renderUI();
        }

        function commitChar() {
            if(State.pendingChar) {
                State.text += State.pendingChar;
                State.pendingChar = "";
                State.lastKey = null;
                renderUI();
            }
        }

        function applyCaps(c) { return State.capsMode ? c.toUpperCase() : c.toLowerCase(); }

        // --- NAV HANDLERS ---
        function handleSoftLeft() {
            SoundEngine.click();
            if (State.mode === 'CHAT') {
                State.mode = 'MENU';
                State.menuIndex = 0;
            } else if (State.mode === 'MENU') {
                executeMenuAction();
            } else if (State.mode === 'DIALER') {
                if(State.dialBuffer.length > 0) connectTo(State.dialBuffer);
            }
            renderUI();
        }

        function handleSoftRight() {
            SoundEngine.cancel();
            if (State.mode === 'CHAT') {
                if(State.pendingChar) {
                    State.pendingChar = "";
                    State.lastKey = null;
                    clearTimeout(t9Timer);
                } else if(State.text.length > 0) {
                    State.text = State.text.slice(0, -1);
                }
            } else if (State.mode === 'MENU') {
                State.mode = 'CHAT';
            } else if (State.mode === 'DIALER') {
                if(State.dialBuffer.length > 0) {
                    State.dialBuffer = State.dialBuffer.slice(0, -1);
                } else {
                    State.mode = 'MENU';
                }
            } else if (State.mode === 'CONNECTING') {
                State.mode = 'DIALER'; // Cancel connection
            }
            renderUI();
        }

        function handleNav(dir) {
            SoundEngine.click();
            if(State.mode === 'MENU') {
                if(dir === 'UP') State.menuIndex = Math.max(0, State.menuIndex - 1);
                if(dir === 'DOWN') State.menuIndex = Math.min(MENU_ITEMS.length - 1, State.menuIndex + 1);
            } else if (State.mode === 'CHAT') {
                const log = document.getElementById('chat-log');
                if(dir === 'UP') log.scrollTop -= 20;
                if(dir === 'DOWN') log.scrollTop += 20;
            }
            renderUI();
        }

        function executeMenuAction() {
            const action = MENU_ITEMS[State.menuIndex].action;
            if(action === 'GOTO_DIALER') {
                State.mode = 'DIALER';
                State.dialBuffer = "";
            } else if (action === 'TOGGLE_THEME') {
                State.themeIndex = (State.themeIndex + 1) % THEMES.length;
                document.getElementById('phone-wrapper').setAttribute('data-theme', THEMES[State.themeIndex]);
            } else if (action === 'TOGGLE_DARK') {
                document.documentElement.classList.toggle('dark');
            } else if (action === 'RESET_NET') {
                initPeer();
                State.mode = 'CHAT';
            }
            renderUI();
        }

        // --- RENDER ---
        function scrollToBottom() {
             const log = document.getElementById('chat-log');
             log.scrollTop = log.scrollHeight;
        }

        function renderUI() {
            ['chat', 'menu', 'dialer', 'connecting', 'confirmed'].forEach(id => {
                document.getElementById(`screen-${id}`).classList.add('hidden');
            });

            const softL = document.getElementById('soft-left-label');
            const softR = document.getElementById('soft-right-label');
            const modeLbl = document.getElementById('mode-label');

            if(State.mode === 'CHAT') {
                document.getElementById('screen-chat').classList.remove('hidden');
                document.getElementById('confirmed-text').innerText = State.text;
                document.getElementById('pending-text').innerText = State.pendingChar;
                
                softL.innerText = "Menu";
                softR.innerText = "Clear";
                modeLbl.innerText = State.capsMode ? "ABC" : "abc";
                scrollToBottom();

            } else if (State.mode === 'MENU') {
                document.getElementById('screen-menu').classList.remove('hidden');
                softL.innerText = "Select";
                softR.innerText = "Back";
                modeLbl.innerText = "---";

                const list = document.getElementById('menu-list');
                list.innerHTML = MENU_ITEMS.map((item, idx) => `
                    <div class="menu-item px-2 py-2 ${idx === State.menuIndex ? 'selected border border-current/30' : ''}">
                        ${item.label}
                    </div>
                `).join('');

            } else if (State.mode === 'DIALER') {
                document.getElementById('screen-dialer').classList.remove('hidden');
                document.getElementById('dial-input').innerText = State.dialBuffer + (State.dialBuffer.length < 5 ? "_" : "");
                softL.innerText = "Connect";
                softR.innerText = State.dialBuffer.length > 0 ? "Del" : "Back";
                modeLbl.innerText = "123";

            } else if (State.mode === 'CONNECTING') {
                document.getElementById('screen-connecting').classList.remove('hidden');
                softL.innerText = "";
                softR.innerText = "Cancel";
            }
        }

        function addMessage(sender, text, isMe) {
            const log = document.getElementById('chat-log');
            const div = document.createElement('div');
            div.className = `flex flex-col mb-2 ${isMe ? 'items-end' : 'items-start'}`;
            div.innerHTML = `
                <span class="text-[9px] opacity-70 mb-0.5 uppercase font-bold tracking-wider">${sender}</span>
                <span class="bg-current/10 px-2 py-1 rounded max-w-[90%] break-words border-l-2 ${isMe ? 'border-r-2 border-l-0 border-current/50' : 'border-current/50'}">${text}</span>
            `;
            log.appendChild(div);
            scrollToBottom();
        }

        function addSystemMsg(text) {
            const log = document.getElementById('chat-log');
            const div = document.createElement('div');
            div.className = "text-center opacity-70 text-[10px] my-2 border-b border-current/20 pb-1 font-bold";
            div.innerText = text;
            log.appendChild(div);
            scrollToBottom();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 3000);
        }

        function visualFeedback(key) {
            const btn = document.querySelector(`button[data-key="${key}"]`);
            if (btn) {
                btn.classList.add('brightness-75', 'translate-y-[2px]', 'shadow-none');
                setTimeout(() => btn.classList.remove('brightness-75', 'translate-y-[2px]', 'shadow-none'), 100);
            }
        }

        document.addEventListener('keydown', (e) => {
            const k = e.key;
            if (k === ' ' || k === 'ArrowUp' || k === 'ArrowDown') e.preventDefault();
            if (k >= '0' && k <= '9') handleKey(k);
            else if (k === 'Backspace') handleSoftRight();
            else if (k === 'Enter') handleSoftLeft();
            else if (k === '#') handleKey('#');
            else if (k === ' ') handleKey('0');
            else if (k === '*' || k === 'Shift') handleKey('*');
            else if (k === 'ArrowUp') handleNav('UP');
            else if (k === 'ArrowDown') handleNav('DOWN');
            else if (['.', ','].includes(k)) handleKey('1');
        });

    </script>
</body>
</html>
